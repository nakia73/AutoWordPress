sequenceDiagram
    participant Scheduler as Inngest Cron
    participant NextAPI as Next.js API Routes
    participant Inngest as Inngest (Worker)
    participant Writer as AI Worker (Writer)
    participant DB as Supabase (PostgreSQL)
    participant Search as Tavily/Firecrawl API
    participant LLM as Gemini 3.0 Pro (LiteLLM)
    participant ImageGen as Unsplash/Pexels (MVP)
    participant UserWP as WordPress Multisite

    Scheduler->>NextAPI: Trigger: Generate Articles (Auth Header)
    NextAPI->>DB: 今日生成すべき記事を検索
    DB-->>NextAPI: 対象プロダクトリスト

    loop For Each Product
        NextAPI->>Inngest: Job: WRITE_ARTICLE (params)
    end

    NextAPI-->>Scheduler: 200 OK (Queued)

    Writer->>Inngest: Job取得
    Writer->>DB: 記事クラスター情報取得 (Keyword, Stage)

    rect rgb(240, 248, 255)
        note right of Writer: Research & Planning
        Writer->>Search: 検索実行 (Trends, Competitors)
        Search-->>Writer: 検索結果
        Writer->>LLM: 構成案作成 (H2, H3)
    end

    rect rgb(255, 248, 240)
        note right of Writer: Writing & Editing
        Writer->>LLM: 本文執筆 (with Reference)
        Writer->>LLM: 推敲・導線チェック
        LLM-->>Writer: 完成記事 (HTML/Markdown)
    end

    rect rgb(240, 255, 240)
        note right of Writer: Media Generation
        Writer->>ImageGen: アイキャッチ画像生成
        ImageGen-->>Writer: 画像URL
    end

    rect rgb(255, 240, 245)
        note right of Writer: Publishing
        Writer->>UserWP: REST API: 投稿 (Status: Draft/Publish)
        UserWP-->>Writer: Post ID
        Writer->>DB: Article保存 (Linked to WP ID)
    end
