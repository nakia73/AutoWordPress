sequenceDiagram
    actor User
    participant NextUI as Next.js UI (Dashboard)
    participant NextAPI as Next.js API Routes (Backend)
    participant DB as Supabase (PostgreSQL)
    participant Inngest as Inngest (Worker)
    participant Analyzer as AI Worker (Product Analysis)
    participant Provisioner as WP Provisioning Worker
    participant External as External APIs (Gemini/Firecrawl)
    participant Cloudflare as Cloudflare API
    participant VPS as DigitalOcean VPS

    User->>NextUI: サインアップ & プロダクトURL入力
    NextUI->>NextAPI: POST /api/products (URL, info)
    NextAPI->>DB: プロダクトレコード作成 (Status: PENDING)
    NextAPI->>Inngest: Job: ANALYZE_PRODUCT 追加
    NextAPI->>NextUI: 202 Accepted (Polling開始)

    par Async Analysis
        Analyzer->>Inngest: Job取得
        Analyzer->>External: FirecrawlでURL解析
        External-->>Analyzer: 解析結果
        Analyzer->>External: Geminiでペルソナ・クラスター生成
        External-->>Analyzer: 分析結果 (JSON)
        Analyzer->>DB: ProductAnalysis保存 & Status更新
        Analyzer->>Inngest: Job: PROVISION_BLOG 追加
    end

    par Async Provisioning
        Provisioner->>Inngest: Job取得
        Provisioner->>Cloudflare: DNSレコード追加 (blog.yourapp.com)
        Provisioner->>VPS: WP-CLI実行 (wp site create)
        VPS-->>Provisioner: サイト作成完了
        Provisioner->>VPS: 初期設定 (テーマ・プラグイン)
        Provisioner->>DB: BlogSite情報保存 (Active)
    end

    loop Polling
        NextUI->>NextAPI: GET /api/products/:id
        NextAPI->>DB: Status確認
        DB-->>NextUI: Status: ACTIVE / ANALYSIS_COMPLETED
    end

    NextUI-->>User: 「ブログ構築完了！」表示
